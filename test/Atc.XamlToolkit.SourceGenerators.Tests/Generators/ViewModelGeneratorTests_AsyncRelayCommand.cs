namespace Atc.XamlToolkit.SourceGenerators.Tests.Generators;

[SuppressMessage("Design", "MA0048:File name must match type name", Justification = "OK.")]
public sealed partial class ViewModelGeneratorTests
{
    [Fact]
    public void AsyncRelayCommand_NoParameter()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand]
                public Task Save()
                {
                    return Task.CompletedTask;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? saveCommand;

                public IRelayCommandAsync SaveCommand => saveCommand ??= new RelayCommandAsync(Save);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_NoParameter_CustomName()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand("MySave")]
                public Task Save()
                {
                    return Task.CompletedTask;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? mySaveCommand;

                public IRelayCommandAsync MySaveCommand => mySaveCommand ??= new RelayCommandAsync(Save);

                public void DisposeCommands()
                {
                    MySaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_NoParameter_MethodHandlerName()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand]
                public Task SaveHandler()
                {
                    return Task.CompletedTask;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? saveCommand;

                public IRelayCommandAsync SaveCommand => saveCommand ??= new RelayCommandAsync(SaveHandler);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_NoParameter_MethodCommandName()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand]
                public Task SaveCommand()
                {
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? saveCommandX;

                public IRelayCommandAsync SaveCommandX => saveCommandX ??= new RelayCommandAsync(SaveCommand);

                public void DisposeCommands()
                {
                    SaveCommandX.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_NoParameter_MethodCommandHandlerName()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand]
                public Task SaveCommandHandler()
                {
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? saveCommand;

                public IRelayCommandAsync SaveCommand => saveCommand ??= new RelayCommandAsync(SaveCommandHandler);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_NoParameter_CancellationToken()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand]
                public Task Save(CancellationToken cancellationToken)
                {
                    return Task.CompletedTask;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? saveCommand;

                public IRelayCommandAsync SaveCommand => saveCommand ??= new RelayCommandAsync(() => Save(CancellationToken.None));

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_NoParameter_CanExecute()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = nameof(CanSave))]
                public Task Save()
                {
                    return Task.CompletedTask;
                }

                public bool CanSave()
                {
                    return true;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? saveCommand;

                public IRelayCommandAsync SaveCommand => saveCommand ??= new RelayCommandAsync(
                    Save,
                    CanSave);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_NoParameter_CanExecute_Inverted()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = nameof(CanSave), InvertCanExecute = true)]
                public Task Save()
                {
                    return Task.CompletedTask;
                }

                public bool CanSave()
                {
                    return true;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? saveCommand;

                public IRelayCommandAsync SaveCommand => saveCommand ??= new RelayCommandAsync(
                    Save,
                    !CanSave);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_NoParameter_CanExecute_CancellationToken()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = nameof(CanSave))]
                public Task Save(CancellationToken cancellationToken)
                {
                    return Task.CompletedTask;
                }

                public bool CanSave()
                {
                    return true;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? saveCommand;

                public IRelayCommandAsync SaveCommand => saveCommand ??= new RelayCommandAsync(
                    () => Save(CancellationToken.None),
                    CanSave);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_NoParameter_MultiHandlerParameterValues_CanExecute_CancellationToken()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = nameof(CanSave))]
                public async Task Save(
                    string val1,
                    int val2,
                    bool val3,
                    Atc.Data.Models.LogItem logItem,
                    CancellationToken cancellationToken)
                {
                    await Task.Delay(1, cancellationToken).ConfigureAwait(false);
                }

                public bool CanSave(
                    string val1,
                    int val2,
                    bool val3,
                    Atc.Data.Models.LogItem logItem)
                {
                    return true;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<(string, int, bool, Atc.Data.Models.LogItem)>? saveCommand;

                public IRelayCommandAsync<(string, int, bool, Atc.Data.Models.LogItem)> SaveCommand => saveCommand ??= new RelayCommandAsync<(string, int, bool, Atc.Data.Models.LogItem)>(
                    x => Save(x.Item1, x.Item2, x.Item3, x.Item4, CancellationToken.None),
                    x => CanSave(x.Item1, x.Item2, x.Item3, x.Item4));

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ParameterString()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand]
                public Task Save(string val)
                {
                    return Task.CompletedTask;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<string>? saveCommand;

                public IRelayCommandAsync<string> SaveCommand => saveCommand ??= new RelayCommandAsync<string>(Save);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ParameterInt()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand]
                public Task Save(int val)
                {
                    return Task.CompletedTask;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<int>? saveCommand;

                public IRelayCommandAsync<int> SaveCommand => saveCommand ??= new RelayCommandAsync<int>(Save);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ParameterTuple()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand]
                public Task Save((LeftTopRightBottomType DirectionType, int StepMoves) data)
                {
                    return Task.CompletedTask;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<(LeftTopRightBottomType DirectionType, int StepMoves)>? saveCommand;

                public IRelayCommandAsync<(LeftTopRightBottomType DirectionType, int StepMoves)> SaveCommand => saveCommand ??= new RelayCommandAsync<(LeftTopRightBottomType DirectionType, int StepMoves)>(Save);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ParameterString_CanExecute()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = nameof(CanSave))]
                public Task Save(string val)
                {
                    return Task.CompletedTask;
                }

                public bool CanSave(string val)
                {
                    return true;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<string>? saveCommand;

                public IRelayCommandAsync<string> SaveCommand => saveCommand ??= new RelayCommandAsync<string>(
                    Save,
                    CanSave);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ParameterString_CanExecute_CancellationToken()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = nameof(CanSave))]
                public Task Save(string val, CancellationToken cancellationToken)
                {
                    return Task.CompletedTask;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<string>? saveCommand;
            
                public IRelayCommandAsync<string> SaveCommand => saveCommand ??= new RelayCommandAsync<string>(
                    x => Save(x, CancellationToken.None),
                    CanSave);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ParameterInt_CanExecute()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = nameof(CanSave))]
                public Task Save(int val)
                {
                    return Task.CompletedTask;
                }

                public bool CanSave(int val)
                {
                    return true;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<int>? saveCommand;

                public IRelayCommandAsync<int> SaveCommand => saveCommand ??= new RelayCommandAsync<int>(
                    Save,
                    CanSave);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ParameterValue_Single()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(ParameterValue = LeftTopRightBottomType.Left)]
                public Task TurnDirectionSingle(LeftTopRightBottomType leftTopRightBottomType)
                {
                    return Task.CompletedTask;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? turnDirectionSingleCommand;

                public IRelayCommandAsync TurnDirectionSingleCommand => turnDirectionSingleCommand ??= new RelayCommandAsync(() => TurnDirectionSingle(LeftTopRightBottomType.Left));

                public void DisposeCommands()
                {
                    TurnDirectionSingleCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ParameterValue_Multi()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand("MyTestLeft", ParameterValue = LeftTopRightBottomType.Left)]
                [RelayCommand("MyTestTop", ParameterValue = LeftTopRightBottomType.Top)]
                [RelayCommand("MyTestRight", ParameterValue = LeftTopRightBottomType.Right)]
                [RelayCommand("MyTestBottom", ParameterValue = LeftTopRightBottomType.Bottom)]
                public Task TurnDirectionSingle(LeftTopRightBottomType leftTopRightBottomType)
                {
                    return Task.CompletedTask;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? myTestLeftCommand;
                private IRelayCommandAsync? myTestTopCommand;
                private IRelayCommandAsync? myTestRightCommand;
                private IRelayCommandAsync? myTestBottomCommand;

                public IRelayCommandAsync MyTestLeftCommand => myTestLeftCommand ??= new RelayCommandAsync(() => TurnDirectionSingle(LeftTopRightBottomType.Left));

                public IRelayCommandAsync MyTestTopCommand => myTestTopCommand ??= new RelayCommandAsync(() => TurnDirectionSingle(LeftTopRightBottomType.Top));

                public IRelayCommandAsync MyTestRightCommand => myTestRightCommand ??= new RelayCommandAsync(() => TurnDirectionSingle(LeftTopRightBottomType.Right));

                public IRelayCommandAsync MyTestBottomCommand => myTestBottomCommand ??= new RelayCommandAsync(() => TurnDirectionSingle(LeftTopRightBottomType.Bottom));

                public void DisposeCommands()
                {
                    MyTestLeftCommand.Dispose();
                    MyTestTopCommand.Dispose();
                    MyTestRightCommand.Dispose();
                    MyTestBottomCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ParameterValues_Multi()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand("MyTestLeft", ParameterValues = [LeftTopRightBottomType.Left, 1])]
                [RelayCommand("MyTestTop", ParameterValues = [LeftTopRightBottomType.Top, 1])]
                [RelayCommand("MyTestRight", ParameterValues = [LeftTopRightBottomType.Right, 1])]
                [RelayCommand("MyTestBottom", ParameterValues = [LeftTopRightBottomType.Bottom, 1])]
                public Task TurnDirectionSingle(LeftTopRightBottomType leftTopRightBottomType, int steps)
                {
                    return Task.CompletedTask;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? myTestLeftCommand;
                private IRelayCommandAsync? myTestTopCommand;
                private IRelayCommandAsync? myTestRightCommand;
                private IRelayCommandAsync? myTestBottomCommand;

                public IRelayCommandAsync MyTestLeftCommand => myTestLeftCommand ??= new RelayCommandAsync(() => TurnDirectionSingle(LeftTopRightBottomType.Left, 1));

                public IRelayCommandAsync MyTestTopCommand => myTestTopCommand ??= new RelayCommandAsync(() => TurnDirectionSingle(LeftTopRightBottomType.Top, 1));

                public IRelayCommandAsync MyTestRightCommand => myTestRightCommand ??= new RelayCommandAsync(() => TurnDirectionSingle(LeftTopRightBottomType.Right, 1));

                public IRelayCommandAsync MyTestBottomCommand => myTestBottomCommand ??= new RelayCommandAsync(() => TurnDirectionSingle(LeftTopRightBottomType.Bottom, 1));

                public void DisposeCommands()
                {
                    MyTestLeftCommand.Dispose();
                    MyTestTopCommand.Dispose();
                    MyTestRightCommand.Dispose();
                    MyTestBottomCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ParameterValues_Multi_Invalid_DuplicateName()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(ParameterValues = [LeftTopRightBottomType.Left, 1])]
                [RelayCommand(ParameterValues = [LeftTopRightBottomType.Top, 1])]
                [RelayCommand(ParameterValues = [LeftTopRightBottomType.Right, 1])]
                [RelayCommand(ParameterValues = [LeftTopRightBottomType.Bottom, 1])]
                public Task TurnDirectionSingle(LeftTopRightBottomType leftTopRightBottomType, int steps)
                {
                    return Task.CompletedTask;
                }
            }
            """;

        var expectedErrorCodes = new[] { "AtcXamlToolkit0001" };

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultHasDiagnostics(expectedErrorCodes, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ParameterValues_Multi_CanExecute()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand("MyTestLeft", CanExecute = nameof(CanTurnDirectionSingle), ParameterValues = [LeftTopRightBottomType.Left, 1])]
                [RelayCommand("MyTestTop", CanExecute = nameof(CanTurnDirectionSingle), ParameterValues = [LeftTopRightBottomType.Top, 1])]
                [RelayCommand("MyTestRight", CanExecute = nameof(CanTurnDirectionSingle), ParameterValues = [LeftTopRightBottomType.Right, 1])]
                [RelayCommand("MyTestBottom", CanExecute = nameof(CanTurnDirectionSingle), ParameterValues = [LeftTopRightBottomType.Bottom, 1])]
                public Task TurnDirectionSingle(LeftTopRightBottomType leftTopRightBottomType, int steps)
                {
                    return Task.CompletedTask;
                }

                public bool CanTurnDirectionSingle(LeftTopRightBottomType leftTopRightBottomType, int steps)
                {
                    return true;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? myTestLeftCommand;
                private IRelayCommandAsync? myTestTopCommand;
                private IRelayCommandAsync? myTestRightCommand;
                private IRelayCommandAsync? myTestBottomCommand;
            
                public IRelayCommandAsync MyTestLeftCommand => myTestLeftCommand ??= new RelayCommandAsync(
                    () => TurnDirectionSingle(LeftTopRightBottomType.Left, 1),
                    CanTurnDirectionSingle(LeftTopRightBottomType.Left, 1));

                public IRelayCommandAsync MyTestTopCommand => myTestTopCommand ??= new RelayCommandAsync(
                    () => TurnDirectionSingle(LeftTopRightBottomType.Top, 1),
                    CanTurnDirectionSingle(LeftTopRightBottomType.Top, 1));

                public IRelayCommandAsync MyTestRightCommand => myTestRightCommand ??= new RelayCommandAsync(
                    () => TurnDirectionSingle(LeftTopRightBottomType.Right, 1),
                    CanTurnDirectionSingle(LeftTopRightBottomType.Right, 1));

                public IRelayCommandAsync MyTestBottomCommand => myTestBottomCommand ??= new RelayCommandAsync(
                    () => TurnDirectionSingle(LeftTopRightBottomType.Bottom, 1),
                    CanTurnDirectionSingle(LeftTopRightBottomType.Bottom, 1));

                public void DisposeCommands()
                {
                    MyTestLeftCommand.Dispose();
                    MyTestTopCommand.Dispose();
                    MyTestRightCommand.Dispose();
                    MyTestBottomCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_NoParameter_CanExecuteOnProperty()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = nameof(CanSave))]
                public Task Save()
                {
                    return Task.CompletedTask;
                }

                public bool CanSave => return true;
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? saveCommand;

                public IRelayCommandAsync SaveCommand => saveCommand ??= new RelayCommandAsync(
                    Save,
                    () => CanSave);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_NoParameter_CanExecuteOnProperty_Inverted()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = nameof(CanSave), InvertCanExecute = true)]
                public Task Save()
                {
                    return Task.CompletedTask;
                }

                public bool CanSave => return true;
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? saveCommand;

                public IRelayCommandAsync SaveCommand => saveCommand ??= new RelayCommandAsync(
                    Save,
                    () => !CanSave);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_NoParameter_CanExecuteOnProperty_CancellationToken()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = nameof(CanSave))]
                public Task Save(CancellationToken cancellationToken)
                {
                    return Task.CompletedTask;
                }

                public bool CanSave => return true;
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? saveCommand;

                public IRelayCommandAsync SaveCommand => saveCommand ??= new RelayCommandAsync(
                    () => Save(CancellationToken.None),
                    () => CanSave);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ParameterString_CanExecuteOnProperty()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = nameof(CanSave))]
                public Task Save(string val)
                {
                    return Task.CompletedTask;
                }

                public bool CanSave => return true;
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<string>? saveCommand;

                public IRelayCommandAsync<string> SaveCommand => saveCommand ??= new RelayCommandAsync<string>(
                    Save,
                    _ => CanSave);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ParameterString_CanExecuteOnObservableProperty()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = nameof(CanSave))]
                public Task Save(string val)
                {
                    return Task.CompletedTask;
                }

                [ObservableProperty] private bool canSave;
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<string>? saveCommand;

                public IRelayCommandAsync<string> SaveCommand => saveCommand ??= new RelayCommandAsync<string>(
                    Save,
                    _ => CanSave);

                public bool CanSave
                {
                    get => canSave;
                    set
                    {
                        if (canSave == value)
                        {
                            return;
                        }

                        canSave = value;
                        RaisePropertyChanged(nameof(CanSave));
                    }
                }

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ParameterString_CanExecuteOnNamedObservableProperty()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = "MyCanSave")]
                public Task Save(string val)
                {
                    return Task.CompletedTask;
                }

                [ObservableProperty("MyCanSave")] private bool canSave;
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<string>? saveCommand;

                public IRelayCommandAsync<string> SaveCommand => saveCommand ??= new RelayCommandAsync<string>(
                    Save,
                    _ => MyCanSave);

                public bool MyCanSave
                {
                    get => canSave;
                    set
                    {
                        if (canSave == value)
                        {
                            return;
                        }

                        canSave = value;
                        RaisePropertyChanged(nameof(MyCanSave));
                    }
                }

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_NoParameter_MultiHandlerParameterValues_CanExecuteOnProperty_CancellationToken()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = nameof(CanSave))]
                public async Task Save(
                    string val1,
                    int val2,
                    bool val3,
                    Atc.Data.Models.LogItem logItem,
                    CancellationToken cancellationToken)
                {
                    await Task.Delay(1, cancellationToken).ConfigureAwait(false);
                }

                public bool CanSave => true;
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<(string, int, bool, Atc.Data.Models.LogItem)>? saveCommand;

                public IRelayCommandAsync<(string, int, bool, Atc.Data.Models.LogItem)> SaveCommand => saveCommand ??= new RelayCommandAsync<(string, int, bool, Atc.Data.Models.LogItem)>(
                    x => Save(x.Item1, x.Item2, x.Item3, x.Item4, CancellationToken.None),
                    x => CanSave);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ExecuteOnBackgroundThread_NoParameter()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(ExecuteOnBackgroundThread = true)]
                public async Task Save()
                {
                    await Task.Delay(20_000).ConfigureAwait(false);
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? saveCommand;
            
                public IRelayCommandAsync SaveCommand => saveCommand ??= new RelayCommandAsync(
                    () => Task.Run(Save));

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ExecuteOnBackgroundThread_NoParameter_CancellationToken()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(ExecuteOnBackgroundThread = true)]
                public async Task Save(CancellationToken cancellationToken)
                {
                    await Task.Delay(20_000, cancellationToken).ConfigureAwait(false);
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? saveCommand;
            
                public IRelayCommandAsync SaveCommand => saveCommand ??= new RelayCommandAsync(
                    () => Task.Run(() => Save(CancellationToken.None)));

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ExecuteOnBackgroundThread_NoParameter_CanExecute()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = nameof(CanSave), ExecuteOnBackgroundThread = true)]
                public async Task Save()
                {
                    await Task.Delay(20_000).ConfigureAwait(false);
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? saveCommand;
            
                public IRelayCommandAsync SaveCommand => saveCommand ??= new RelayCommandAsync(
                    () => Task.Run(Save),
                    CanSave);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ExecuteOnBackgroundThread_NoParameter_CanExecute_CancellationToken()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = nameof(CanSave), ExecuteOnBackgroundThread = true)]
                public async Task Save(CancellationToken cancellationToken)
                {
                    await Task.Delay(20_000).ConfigureAwait(false);
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? saveCommand;
            
                public IRelayCommandAsync SaveCommand => saveCommand ??= new RelayCommandAsync(
                    () => Task.Run(() => Save(CancellationToken.None)),
                    CanSave);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ExecuteOnBackgroundThread_ParameterString()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(ExecuteOnBackgroundThread = true)]
                public async Task Save(string val)
                {
                    await Task.Delay(20_000).ConfigureAwait(false);
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<string>? saveCommand;
            
                public IRelayCommandAsync<string> SaveCommand => saveCommand ??= new RelayCommandAsync<string>(
                    x => Task.Run(() => Save(x)));

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ExecuteOnBackgroundThread_ParameterString_CancellationToken()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(ExecuteOnBackgroundThread = true)]
                public async Task Save(string val, CancellationToken cancellationToken)
                {
                    await Task.Delay(20_000, cancellationToken).ConfigureAwait(false);
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<string>? saveCommand;
            
                public IRelayCommandAsync<string> SaveCommand => saveCommand ??= new RelayCommandAsync<string>(
                    x => Task.Run(() => Save(x, CancellationToken.None)));

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ExecuteOnBackgroundThread_ParameterString_CanExecute()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = nameof(CanSave), ExecuteOnBackgroundThread = true)]
                public async Task Save(string val)
                {
                    await Task.Delay(20_000).ConfigureAwait(false);
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<string>? saveCommand;
            
                public IRelayCommandAsync<string> SaveCommand => saveCommand ??= new RelayCommandAsync<string>(
                    x => Task.Run(() => Save(x)),
                    CanSave);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ExecuteOnBackgroundThread_ParameterString_CanExecute_CancellationToken()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = nameof(CanSave), ExecuteOnBackgroundThread = true)]
                public async Task Save(string val, CancellationToken cancellationToken)
                {
                    await Task.Delay(20_000).ConfigureAwait(false);
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<string>? saveCommand;
            
                public IRelayCommandAsync<string> SaveCommand => saveCommand ??= new RelayCommandAsync<string>(
                    x => Task.Run(() => Save(x, CancellationToken.None)),
                    CanSave);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ExecuteOnBackgroundThread_NoParameter_CanExecuteOnProperty()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = nameof(CanSave), ExecuteOnBackgroundThread = true)]
                public Task Save()
                {
                    return Task.CompletedTask;
                }

                public bool CanSave => return true;
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? saveCommand;

                public IRelayCommandAsync SaveCommand => saveCommand ??= new RelayCommandAsync(
                    () => Task.Run(Save),
                    () => CanSave);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ExecuteOnBackgroundThread_ParameterString_CanExecuteOnProperty()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = nameof(CanSave), ExecuteOnBackgroundThread = true)]
                public Task Save(string val)
                {
                    return Task.CompletedTask;
                }

                public bool CanSave => return true;
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<string>? saveCommand;

                public IRelayCommandAsync<string> SaveCommand => saveCommand ??= new RelayCommandAsync<string>(
                    x => Task.Run(() => Save(x)),
                    _ => CanSave);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ExecuteOnBackgroundThread_ParameterString_CanExecuteOnObservableProperty()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = nameof(CanSave), ExecuteOnBackgroundThread = true)]
                public Task Save(string val)
                {
                    return Task.CompletedTask;
                }

                [ObservableProperty] private bool canSave;
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<string>? saveCommand;

                public IRelayCommandAsync<string> SaveCommand => saveCommand ??= new RelayCommandAsync<string>(
                    x => Task.Run(() => Save(x)),
                    _ => CanSave);

                public bool CanSave
                {
                    get => canSave;
                    set
                    {
                        if (canSave == value)
                        {
                            return;
                        }

                        canSave = value;
                        RaisePropertyChanged(nameof(CanSave));
                    }
                }

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_ExecuteOnBackgroundThread_ParameterString_CanExecuteOnNamedObservableProperty()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = "MyCanSave", ExecuteOnBackgroundThread = true)]
                public Task Save(string val)
                {
                    return Task.CompletedTask;
                }

                [ObservableProperty("MyCanSave")] private bool canSave;
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<string>? saveCommand;

                public IRelayCommandAsync<string> SaveCommand => saveCommand ??= new RelayCommandAsync<string>(
                    x => Task.Run(() => Save(x)),
                    _ => MyCanSave);

                public bool MyCanSave
                {
                    get => canSave;
                    set
                    {
                        if (canSave == value)
                        {
                            return;
                        }

                        canSave = value;
                        RaisePropertyChanged(nameof(MyCanSave));
                    }
                }

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_AutoSetIsBusy_NoParameter()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(AutoSetIsBusy = true)]
                public Task Save()
                {
                    return Task.CompletedTask;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? saveCommand;

                public IRelayCommandAsync SaveCommand => saveCommand ??= new RelayCommandAsync(
                    async () =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await Task
                                .Run(Save)
                                .ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    });

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_AutoSetIsBusy_NoParameter_Async()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(AutoSetIsBusy = true)]
                public async Task Save()
                {
                    await Task.Delay(1).ConfigureAwait(false);
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? saveCommand;

                public IRelayCommandAsync SaveCommand => saveCommand ??= new RelayCommandAsync(
                    async () =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await Save().ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    });

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_AutoSetIsBusy_NoParameter_CancellationToken()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(AutoSetIsBusy = true)]
                public Task Save(CancellationToken cancellationToken)
                {
                    return Task.CompletedTask;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? saveCommand;
            
                public IRelayCommandAsync SaveCommand => saveCommand ??= new RelayCommandAsync(
                    async () =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await Save(CancellationToken.None).ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    });

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_AutoSetIsBusy_NoParameter_CancellationToken_Async()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(AutoSetIsBusy = true)]
                public async Task Save(CancellationToken cancellationToken)
                {
                    await Task.Delay(1).ConfigureAwait(false);
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? saveCommand;

                public IRelayCommandAsync SaveCommand => saveCommand ??= new RelayCommandAsync(
                    async () =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await Save(CancellationToken.None).ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    });

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_AutoSetIsBusy_ParameterString()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(AutoSetIsBusy = true)]
                public Task Save(string val)
                {
                    return Task.CompletedTask;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<string>? saveCommand;

                public IRelayCommandAsync<string> SaveCommand => saveCommand ??= new RelayCommandAsync<string>(
                    async x =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await Save(x).ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    });

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_AutoSetIsBusy_ParameterInt()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(AutoSetIsBusy = true)]
                public Task Save(int val)
                {
                    return Task.CompletedTask;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<int>? saveCommand;

                public IRelayCommandAsync<int> SaveCommand => saveCommand ??= new RelayCommandAsync<int>(
                    async x =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await Save(x).ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    });

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_AutoSetIsBusy_ParameterInt_CancellationToken()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(AutoSetIsBusy = true)]
                public Task Save(int val, CancellationToken cancellationToken)
                {
                    return Task.CompletedTask;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<int>? saveCommand;

                public IRelayCommandAsync<int> SaveCommand => saveCommand ??= new RelayCommandAsync<int>(
                    async x =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await Save(x, CancellationToken.None).ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    });

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_AutoSetIsBusy_ParameterValue_Multi()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand("MyTestLeft", ParameterValue = LeftTopRightBottomType.Left, AutoSetIsBusy = true)]
                [RelayCommand("MyTestTop", ParameterValue = LeftTopRightBottomType.Top, AutoSetIsBusy = true)]
                [RelayCommand("MyTestRight", ParameterValue = LeftTopRightBottomType.Right, AutoSetIsBusy = true)]
                [RelayCommand("MyTestBottom", ParameterValue = LeftTopRightBottomType.Bottom, AutoSetIsBusy = true)]
                public Task TurnDirectionSingle(LeftTopRightBottomType leftTopRightBottomType)
                {
                    return Task.CompletedTask;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? myTestLeftCommand;
                private IRelayCommandAsync? myTestTopCommand;
                private IRelayCommandAsync? myTestRightCommand;
                private IRelayCommandAsync? myTestBottomCommand;

                public IRelayCommandAsync MyTestLeftCommand => myTestLeftCommand ??= new RelayCommandAsync(
                    async () =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await TurnDirectionSingle(LeftTopRightBottomType.Left).ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    });

                public IRelayCommandAsync MyTestTopCommand => myTestTopCommand ??= new RelayCommandAsync(
                    async () =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await TurnDirectionSingle(LeftTopRightBottomType.Top).ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    });

                public IRelayCommandAsync MyTestRightCommand => myTestRightCommand ??= new RelayCommandAsync(
                    async () =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await TurnDirectionSingle(LeftTopRightBottomType.Right).ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    });

                public IRelayCommandAsync MyTestBottomCommand => myTestBottomCommand ??= new RelayCommandAsync(
                    async () =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await TurnDirectionSingle(LeftTopRightBottomType.Bottom).ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    });

                public void DisposeCommands()
                {
                    MyTestLeftCommand.Dispose();
                    MyTestTopCommand.Dispose();
                    MyTestRightCommand.Dispose();
                    MyTestBottomCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_AutoSetIsBusy_ExecuteOnBackgroundThread_NoParameter()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(ExecuteOnBackgroundThread = true, AutoSetIsBusy = true)]
                public Task Save()
                {
                    return Task.CompletedTask;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? saveCommand;

                public IRelayCommandAsync SaveCommand => saveCommand ??= new RelayCommandAsync(
                    async () =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await Task
                                .Run(Save)
                                .ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    });

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_AutoSetIsBusy_ExecuteOnBackgroundThread_NoParameter_CanExecute()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = nameof(CanSave), ExecuteOnBackgroundThread = true, AutoSetIsBusy = true)]
                public Task Save()
                {
                    return Task.CompletedTask;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? saveCommand;

                public IRelayCommandAsync SaveCommand => saveCommand ??= new RelayCommandAsync(
                    async () =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await Task
                                .Run(Save)
                                .ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    },
                    CanSave);

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_AutoSetIsBusy_ExecuteOnBackgroundThread_ParameterString()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(ExecuteOnBackgroundThread = true, AutoSetIsBusy = true)]
                public async Task Save(string val)
                {
                    await Task.Delay(20_000).ConfigureAwait(false);
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<string>? saveCommand;
            
                public IRelayCommandAsync<string> SaveCommand => saveCommand ??= new RelayCommandAsync<string>(
                    async x =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await Task
                                .Run(() => Save(x))
                                .ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    });

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_AutoSetIsBusy_ExecuteOnBackgroundThread_ParameterString_CancellationToken()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(ExecuteOnBackgroundThread = true, AutoSetIsBusy = true)]
                public async Task Save(string val, CancellationToken cancellationToken)
                {
                    await Task.Delay(20_000, cancellationToken).ConfigureAwait(false);
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<string>? saveCommand;

                public IRelayCommandAsync<string> SaveCommand => saveCommand ??= new RelayCommandAsync<string>(
                    async x =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await Task
                                .Run(() => Save(x, CancellationToken.None))
                                .ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    });

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_AutoSetIsBusy_ExecuteOnBackgroundThread_ParameterValue_Multi()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand("MyTestLeft", ParameterValue = LeftTopRightBottomType.Left, ExecuteOnBackgroundThread = true, AutoSetIsBusy = true)]
                [RelayCommand("MyTestTop", ParameterValue = LeftTopRightBottomType.Top, ExecuteOnBackgroundThread = true, AutoSetIsBusy = true)]
                [RelayCommand("MyTestRight", ParameterValue = LeftTopRightBottomType.Right, ExecuteOnBackgroundThread = true, AutoSetIsBusy = true)]
                [RelayCommand("MyTestBottom", ParameterValue = LeftTopRightBottomType.Bottom, ExecuteOnBackgroundThread = true, AutoSetIsBusy = true)]
                public Task TurnDirectionSingle(LeftTopRightBottomType leftTopRightBottomType)
                {
                    return Task.CompletedTask;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? myTestLeftCommand;
                private IRelayCommandAsync? myTestTopCommand;
                private IRelayCommandAsync? myTestRightCommand;
                private IRelayCommandAsync? myTestBottomCommand;

                public IRelayCommandAsync MyTestLeftCommand => myTestLeftCommand ??= new RelayCommandAsync(
                    async () =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await Task
                                .Run(() => TurnDirectionSingle(LeftTopRightBottomType.Left))
                                .ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    });

                public IRelayCommandAsync MyTestTopCommand => myTestTopCommand ??= new RelayCommandAsync(
                    async () =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await Task
                                .Run(() => TurnDirectionSingle(LeftTopRightBottomType.Top))
                                .ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    });

                public IRelayCommandAsync MyTestRightCommand => myTestRightCommand ??= new RelayCommandAsync(
                    async () =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await Task
                                .Run(() => TurnDirectionSingle(LeftTopRightBottomType.Right))
                                .ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    });

                public IRelayCommandAsync MyTestBottomCommand => myTestBottomCommand ??= new RelayCommandAsync(
                    async () =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await Task
                                .Run(() => TurnDirectionSingle(LeftTopRightBottomType.Bottom))
                                .ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    });

                public void DisposeCommands()
                {
                    MyTestLeftCommand.Dispose();
                    MyTestTopCommand.Dispose();
                    MyTestRightCommand.Dispose();
                    MyTestBottomCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_AutoSetIsBusy_ExecuteOnBackgroundThread_ParameterValues_Multi()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand("MyTestLeft", ParameterValues = [LeftTopRightBottomType.Left, 1], ExecuteOnBackgroundThread = true, AutoSetIsBusy = true)]
                [RelayCommand("MyTestTop", ParameterValues = [LeftTopRightBottomType.Top, 1], ExecuteOnBackgroundThread = true, AutoSetIsBusy = true)]
                [RelayCommand("MyTestRight", ParameterValues = [LeftTopRightBottomType.Right, 1], ExecuteOnBackgroundThread = true, AutoSetIsBusy = true)]
                [RelayCommand("MyTestBottom", ParameterValues = [LeftTopRightBottomType.Bottom, 1], ExecuteOnBackgroundThread = true, AutoSetIsBusy = true)]
                public Task TurnDirectionSingle(LeftTopRightBottomType leftTopRightBottomType, int steps)
                {
                    return Task.CompletedTask;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync? myTestLeftCommand;
                private IRelayCommandAsync? myTestTopCommand;
                private IRelayCommandAsync? myTestRightCommand;
                private IRelayCommandAsync? myTestBottomCommand;
            
                public IRelayCommandAsync MyTestLeftCommand => myTestLeftCommand ??= new RelayCommandAsync(
                    async () =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await Task
                                .Run(() => TurnDirectionSingle(LeftTopRightBottomType.Left, 1))
                                .ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    });
            
                public IRelayCommandAsync MyTestTopCommand => myTestTopCommand ??= new RelayCommandAsync(
                    async () =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await Task
                                .Run(() => TurnDirectionSingle(LeftTopRightBottomType.Top, 1))
                                .ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    });
            
                public IRelayCommandAsync MyTestRightCommand => myTestRightCommand ??= new RelayCommandAsync(
                    async () =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await Task
                                .Run(() => TurnDirectionSingle(LeftTopRightBottomType.Right, 1))
                                .ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    });
            
                public IRelayCommandAsync MyTestBottomCommand => myTestBottomCommand ??= new RelayCommandAsync(
                    async () =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await Task
                                .Run(() => TurnDirectionSingle(LeftTopRightBottomType.Bottom, 1))
                                .ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    });

                public void DisposeCommands()
                {
                    MyTestLeftCommand.Dispose();
                    MyTestTopCommand.Dispose();
                    MyTestRightCommand.Dispose();
                    MyTestBottomCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }

    [Fact]
    public void AsyncRelayCommand_AutoSetIsBusy_ExecuteOnBackgroundThread_NoParameter_MultiHandlerParameterValues_CanExecute_CancellationToken()
    {
        const string inputCode =
            """
            namespace TestNamespace;

            public partial class TestViewModel : ViewModelBase
            {
                [RelayCommand(CanExecute = nameof(CanSave), ExecuteOnBackgroundThread = true, AutoSetIsBusy = true)]
                public async Task Save(
                    string val1,
                    int val2,
                    bool val3,
                    Atc.Data.Models.LogItem logItem,
                    CancellationToken cancellationToken)
                {
                    await Task.Delay(1, cancellationToken).ConfigureAwait(false);
                }

                public bool CanSave(
                    string val1,
                    int val2,
                    bool val3,
                    Atc.Data.Models.LogItem logItem)
                {
                    return true;
                }
            }
            """;

        const string expectedCode =
            """
            // <auto-generated>
            #nullable enable
            using Atc.XamlToolkit.Command;

            namespace TestNamespace;

            public partial class TestViewModel
            {
                private IRelayCommandAsync<(string, int, bool, Atc.Data.Models.LogItem)>? saveCommand;

                public IRelayCommandAsync<(string, int, bool, Atc.Data.Models.LogItem)> SaveCommand => saveCommand ??= new RelayCommandAsync<(string, int, bool, Atc.Data.Models.LogItem)>(
                    async x =>
                    {
                        await Application.Current.Dispatcher
                            .InvokeAsyncIfRequired(() => IsBusy = true)
                            .ConfigureAwait(false);

                        try
                        {
                            await Task
                                .Run(() => Save(x.Item1, x.Item2, x.Item3, x.Item4, CancellationToken.None))
                                .ConfigureAwait(false);
                        }
                        finally
                        {
                            await Application.Current.Dispatcher
                                .InvokeAsyncIfRequired(() => IsBusy = false)
                                .ConfigureAwait(false);
                        }
                    },
                    x => CanSave(x.Item1, x.Item2, x.Item3, x.Item4));

                public void DisposeCommands()
                {
                    SaveCommand.Dispose();
                }
            }

            #nullable disable
            """;

        var generatorResult = RunGenerator<ViewModelGenerator>(inputCode);

        AssertGeneratorRunResultAsEqual(expectedCode, generatorResult);
    }
}